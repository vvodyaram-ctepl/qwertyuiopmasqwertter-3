<form [formGroup]="preludeForm">
    <div class="content-box">
        <div class="content-block">
            <div class="mt-3" *ngIf="!editFlag">Kindly come back after 15 minutes to complete the Prelude Configuration.
            </div>
            <div *ngIf="editFlag">
                <h3 class="mainTitle">Mandatory Fields :</h3>
                <div formArrayName="preludeMandatory" *ngFor="
                    let a of preludeForm.get('preludeMandatory')['controls'];
                    let i = index;
                    let last = last">
                    <b class="mb-1" *ngIf="a.value.label == 'Address Line 1'">Pet Parent Address :</b>
                    <div class="row mb-3" [formGroupName]="i">
                        <div class="col-2">
                            <legend>
                                <label class="label legendLabel">{{a.value.label}} <span class="asterisk">*</span>
                                </label>
                            </legend>
                        </div>
                        <div class="col">
                            <fieldset class="w-fieldset">
                                <legend>
                                    <label class="label">Form </label>
                                </legend>
                                <lib-typeahead [data]="preludeForm.value.preludeMandatory[i].formList"
                                    [disabled]="a.value.disabled || disableFields" matcher="name"
                                    formControlName="formName" (blur)="clearForm(i,1,1)" (keyup)="clearForm(i,1,1)"
                                    class="w-100 mb-0" placeholder="" class="w-100"
                                    (selectedItem)='formNameSelected($event,i,1);' (onClear)="onClearformName(i)">
                                </lib-typeahead>
                            </fieldset>
                            <!--  <validation-message [control]="preludeForm.controls.externalPatientID.controls.fieldName">
                        </validation-message> -->
                        </div>
                        <div class="col">
                            <fieldset class="w-fieldset">
                                <legend>
                                    <label class="label">Category </label>
                                </legend>
                                <lib-typeahead [data]="preludeForm.value.preludeMandatory[i].categoryList"
                                    [disabled]="a.value.disabled || disableFields" matcher="name"
                                    formControlName="category" (blur)="clearForm(i,1,2)" (keyup)="clearForm(i,1,2)"
                                    (selectedItem)='formCategorySelected($event,i,1);' class="w-100 mb-0" placeholder=""
                                    class="w-100">
                                </lib-typeahead>
                            </fieldset>
                            <!-- <validation-message [control]="preludeForm.controls.externalPatientID.controls.category">
                        </validation-message> -->
                        </div>
                        <div class="col">
                            <fieldset class="w-fieldset">
                                <legend>
                                    <label class="label">Prelude Group </label>
                                </legend>
                                <lib-typeahead [data]="preludeForm.value.preludeMandatory[i].preludeGroupList"
                                    [disabled]="a.value.disabled || disableFields" matcher="name"
                                    formControlName="preludeGroup" (blur)="clearForm(i,1,3)" (keyup)="clearForm(i,1,3)"
                                    (selectedItem)='formExtractGroupSelected($event,i,1);getActivePrelude(0, "", 1, i)'
                                    class="w-100 mb-0" placeholder="" class="w-100">
                                </lib-typeahead>
                            </fieldset>
                            <!-- <validation-message [control]="preludeForm.controls.externalPatientID.controls.preludeGroup">
                        </validation-message> -->
                        </div>
                        <div class="col">
                            <fieldset class="w-fieldset">
                                <legend>
                                    <label class="label">Field Name</label>
                                </legend>
                                <lib-typeahead [data]="preludeForm.value.preludeMandatory[i].fieldNameList"
                                    [disabled]="a.value.disabled || disableFields" matcher="name"
                                    (click)='filterPreludeList(i,1);' (keyup)='filterPreludeList(i,1);'
                                    (selectedItem)='filterPreludeList(i,1);' formControlName="fieldName"
                                    class="w-100 mb-0" placeholder="" class="w-100">
                                </lib-typeahead>
                            </fieldset>
                            <!-- <validation-message [control]="preludeForm.controls.externalPatientID.controls.fieldName">
                        </validation-message> -->
                        </div>
                    </div>
                </div>
                <h3 class="mainTitle">Optional Fields :</h3>
                <div formArrayName="arr" *ngFor="
                    let a of preludeForm.get('arr')['controls'];
                    let i = index;
                    let last = last">
                    <div [formGroupName]="i">
                        <div class="row mb-3">
                            <div class="col-2">
                            </div>
                            <div class="col">
                                <fieldset class="w-fieldset">
                                    <legend>
                                        <label class="label">Form </label>
                                    </legend>
                                    <lib-typeahead [data]="preludeForm.value.arr[i].formList" matcher="name"
                                        formControlName="formName" (blur)="clearForm(i,2,1)" (keyup)="clearForm(i,2,1)"
                                        class="w-100 mb-0" placeholder="" class="w-100" [disabled]="disableFields"
                                        (selectedItem)='formNameSelected($event,i,2);' (onClear)="onClearformName(i)">
                                    </lib-typeahead>
                                </fieldset>
                                <validation-message [control]="preludeForm.get('arr').controls[i].controls.formName">
                                </validation-message>
                            </div>
                            <div class="col">
                                <fieldset class="w-fieldset">
                                    <legend>
                                        <label class="label">Category </label>
                                    </legend>
                                    <lib-typeahead [data]="preludeForm.value.arr[i].categoryList" matcher="name"
                                        formControlName="category" (blur)="clearForm(i,2,2)" (keyup)="clearForm(i,2,2)"
                                        (selectedItem)='formCategorySelected($event,i,2);' class="w-100 mb-0"
                                        [disabled]="disableFields" placeholder="" class="w-100">
                                    </lib-typeahead>
                                </fieldset>
                                <validation-message [control]="preludeForm.get('arr').controls[i].controls.category">
                                </validation-message>
                            </div>
                            <div class="col">
                                <fieldset class="w-fieldset">
                                    <legend>
                                        <label class="label">Prelude Group </label>
                                    </legend>
                                    <lib-typeahead [data]="preludeForm.value.arr[i].preludeGroupList" matcher="name"
                                        formControlName="preludeGroup" (blur)="clearForm(i,2,3)"
                                        (keyup)="clearForm(i,2,3)" [disabled]="disableFields"
                                        (selectedItem)='formExtractGroupSelected($event,i,2);getActivePrelude(1,"",2,i)'
                                        class="w-100 mb-0" placeholder="" class="w-100">
                                    </lib-typeahead>
                                </fieldset>
                                <validation-message
                                    [control]="preludeForm.get('arr').controls[i].controls.preludeGroup">
                                </validation-message>
                            </div>
                            <div class="col">
                                <div class="row">
                                    <div class="col">

                                        <fieldset class="w-fieldset">
                                            <legend>
                                                <label class="label">Field Name</label>
                                            </legend>
                                            <lib-typeahead [data]="preludeForm.value.arr[i].fieldNameList"
                                                matcher="name" (click)='filterPreludeList(i,2);'
                                                (keyup)='filterPreludeList(i,2);' [disabled]="disableFields"
                                                (selectedItem)='filterPreludeList(i,2);' formControlName="fieldName"
                                                class="w-100 mb-0" placeholder="" class="w-100">
                                            </lib-typeahead>
                                        </fieldset>
                                        <validation-message
                                            [control]="preludeForm.get('arr').controls[i].controls.fieldName">
                                        </validation-message>
                                    </div>
                                    <div class="col-4 center-align pl-0 pr-0" *ngIf="!(disableFields)">
                                        <div class="card icon-card-list red-bg mr-2 mt-3 pointer-cursor" title="Remove"
                                            (click)="removeItem(i);clearForm(i,2,2)"
                                            *ngIf="preludeForm.value.arr.length > 1">
                                            <span class=" pointer-cursor size-17" title="Remove">-</span>
                                        </div>

                                        <div class="card icon-card-list blue-bg mt-3" title="Add" (click)="addItem()"
                                            [ngClass]="!(a.value.formName && a.value.category && a.value.preludeGroup && a.value.fieldName)?'disabledbutton':''"
                                            *ngIf="last">
                                            <span class="fa fa-plus pointer-cursor size-15" style="color:white;"
                                                title="Add"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
            <!-- {{preludeForm.value | json}}  -->
            <div class="row">
                <div class="col-12">
                    <div class="float-right">
                        <button class="btn btn-secondary" type="button" (click)="back()">
                            Back</button>&nbsp;&nbsp;
                        <button *ngIf="!editFlag" class="btn btn-primary" type="button" (click)="confrimSubmit()">
                            <span>submit</span> <!-- || (editFlag && !isExternalData) -->
                        </button>
                        <button *ngIf="editFlag" class="btn btn-primary" type="button" (click)="next()">
                            <span>Next</span> <!-- && isExternalData -->
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>


<ng-template #studySubmitPopup let-c="close" let-d="dismiss">

    <div class="modal-body">
        <div class="row mb-3">
            <div class="col-12">

                <p>
                    <b>Please ensure that the Prelude Mandatory fields are accurately defined for the
                        <b>{{studyName}}</b>
                        study.
                        No editing is permitted to the Mandatory fields once submitted.</b>

                </p>
            </div>
        </div>
        <div class="row">
            <div class="col-12 mb-4">
                <button type="submit" class="btn btn-secondary btn-custom float-right ml-2" (click)="d('Cross click')">
                    No
                </button>
                <button type="submit" class="btn btn-primary btn-custom float-right" (click)="gotToNext()">
                    Yes
                </button>
            </div>
        </div>
    </div>
</ng-template>